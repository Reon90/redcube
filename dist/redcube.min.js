!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("redcube",[],t):"object"==typeof exports?exports.redcube=t():e.redcube=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(e,t,r){"use strict";function n(e){var t=[new l,new l,new l,new l,new l,new l],r=e.elements,n=r[0],i=r[1],a=r[2],s=r[3],o=r[4],u=r[5],h=r[6],c=r[7],f=r[8],m=r[9],v=r[10],d=r[11],p=r[12],y=r[13],b=r[14],g=r[15];return t[0].set([s-n,c-o,d-f,g-p]).normalize(),t[1].set([s+n,c+o,d+f,g+p]).normalize(),t[2].set([s+i,c+u,d+m,g+y]).normalize(),t[3].set([s-i,c-u,d-m,g-y]).normalize(),t[4].set([s-a,c-h,d-v,g-b]).normalize(),t[5].set([s+a,c+h,d+v,g+b]).normalize(),t}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(e){var t=void 0,r=void 0,n=void 0;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(4),t=0;t<4;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,1])};a.prototype.set=function(e){var t=void 0,r=void 0,n=void 0;if(r=e,n=this.elements,r!==n){for(t=0;t<4;++t)n[t]=r[t];return this}};var s=function(e){var t=void 0,r=void 0,n=void 0;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(9),t=0;t<9;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])};s.prototype.set=function(e){var t=void 0,r=void 0,n=void 0;if(r=e,n=this.elements,r!==n){for(t=0;t<9;++t)n[t]=r[t];return this}},s.prototype.normalFromMat4=function(e){var t=this.elements;e=e.elements;var r=e[0],n=e[1],i=e[2],a=e[3],s=e[4],o=e[5],u=e[6],l=e[7],h=e[8],c=e[9],f=e[10],m=e[11],v=e[12],d=e[13],p=e[14],y=e[15],b=r*o-n*s,g=r*u-i*s,x=r*l-a*s,w=n*u-i*o,M=n*l-a*o,k=i*l-a*u,E=h*d-c*v,_=h*p-f*v,T=h*y-m*v,A=c*p-f*d,O=c*y-m*d,j=f*y-m*p,S=b*j-g*O+x*A+w*T-M*_+k*E;return S?(S=1/S,t[0]=(o*j-u*O+l*A)*S,t[1]=(u*T-s*j-l*_)*S,t[2]=(s*O-o*T+l*E)*S,t[3]=(i*O-n*j-a*A)*S,t[4]=(r*j-i*T+a*_)*S,t[5]=(n*T-r*O-a*E)*S,t[6]=(d*k-p*M+y*w)*S,t[7]=(p*x-v*k-y*g)*S,t[8]=(v*M-d*x+y*b)*S,this):null};var o=function(e){var t=void 0,r=void 0,n=void 0;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(16),t=0;t<16;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])};o.prototype.set=function(e){var t=void 0,r=void 0,n=void 0;if(r=e,n=this.elements,r!==n){for(t=0;t<16;++t)n[t]=r[t];return this}},o.prototype.concat=function(e){var t=void 0,r=void 0,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,u=void 0;if(r=this.elements,n=this.elements,i=e.elements,r===i)for(i=new Float32Array(16),t=0;t<16;++t)i[t]=r[t];for(t=0;t<4;t++)a=n[t],s=n[t+4],o=n[t+8],u=n[t+12],r[t]=a*i[0]+s*i[1]+o*i[2]+u*i[3],r[t+4]=a*i[4]+s*i[5]+o*i[6]+u*i[7],r[t+8]=a*i[8]+s*i[9]+o*i[10]+u*i[11],r[t+12]=a*i[12]+s*i[13]+o*i[14]+u*i[15];return this},o.prototype.multiply=o.prototype.concat,o.prototype.setInverseOf=function(e){var t=void 0,r=void 0,n=void 0,i=void 0,a=void 0;if(r=e.elements,n=this.elements,i=new Float32Array(16),i[0]=r[5]*r[10]*r[15]-r[5]*r[11]*r[14]-r[9]*r[6]*r[15]+r[9]*r[7]*r[14]+r[13]*r[6]*r[11]-r[13]*r[7]*r[10],i[4]=-r[4]*r[10]*r[15]+r[4]*r[11]*r[14]+r[8]*r[6]*r[15]-r[8]*r[7]*r[14]-r[12]*r[6]*r[11]+r[12]*r[7]*r[10],i[8]=r[4]*r[9]*r[15]-r[4]*r[11]*r[13]-r[8]*r[5]*r[15]+r[8]*r[7]*r[13]+r[12]*r[5]*r[11]-r[12]*r[7]*r[9],i[12]=-r[4]*r[9]*r[14]+r[4]*r[10]*r[13]+r[8]*r[5]*r[14]-r[8]*r[6]*r[13]-r[12]*r[5]*r[10]+r[12]*r[6]*r[9],i[1]=-r[1]*r[10]*r[15]+r[1]*r[11]*r[14]+r[9]*r[2]*r[15]-r[9]*r[3]*r[14]-r[13]*r[2]*r[11]+r[13]*r[3]*r[10],i[5]=r[0]*r[10]*r[15]-r[0]*r[11]*r[14]-r[8]*r[2]*r[15]+r[8]*r[3]*r[14]+r[12]*r[2]*r[11]-r[12]*r[3]*r[10],i[9]=-r[0]*r[9]*r[15]+r[0]*r[11]*r[13]+r[8]*r[1]*r[15]-r[8]*r[3]*r[13]-r[12]*r[1]*r[11]+r[12]*r[3]*r[9],i[13]=r[0]*r[9]*r[14]-r[0]*r[10]*r[13]-r[8]*r[1]*r[14]+r[8]*r[2]*r[13]+r[12]*r[1]*r[10]-r[12]*r[2]*r[9],i[2]=r[1]*r[6]*r[15]-r[1]*r[7]*r[14]-r[5]*r[2]*r[15]+r[5]*r[3]*r[14]+r[13]*r[2]*r[7]-r[13]*r[3]*r[6],i[6]=-r[0]*r[6]*r[15]+r[0]*r[7]*r[14]+r[4]*r[2]*r[15]-r[4]*r[3]*r[14]-r[12]*r[2]*r[7]+r[12]*r[3]*r[6],i[10]=r[0]*r[5]*r[15]-r[0]*r[7]*r[13]-r[4]*r[1]*r[15]+r[4]*r[3]*r[13]+r[12]*r[1]*r[7]-r[12]*r[3]*r[5],i[14]=-r[0]*r[5]*r[14]+r[0]*r[6]*r[13]+r[4]*r[1]*r[14]-r[4]*r[2]*r[13]-r[12]*r[1]*r[6]+r[12]*r[2]*r[5],i[3]=-r[1]*r[6]*r[11]+r[1]*r[7]*r[10]+r[5]*r[2]*r[11]-r[5]*r[3]*r[10]-r[9]*r[2]*r[7]+r[9]*r[3]*r[6],i[7]=r[0]*r[6]*r[11]-r[0]*r[7]*r[10]-r[4]*r[2]*r[11]+r[4]*r[3]*r[10]+r[8]*r[2]*r[7]-r[8]*r[3]*r[6],i[11]=-r[0]*r[5]*r[11]+r[0]*r[7]*r[9]+r[4]*r[1]*r[11]-r[4]*r[3]*r[9]-r[8]*r[1]*r[7]+r[8]*r[3]*r[5],i[15]=r[0]*r[5]*r[10]-r[0]*r[6]*r[9]-r[4]*r[1]*r[10]+r[4]*r[2]*r[9]+r[8]*r[1]*r[6]-r[8]*r[2]*r[5],0===(a=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12]))return this;for(a=1/a,t=0;t<16;t++)n[t]=i[t]*a;return this},o.prototype.invert=function(){return this.setInverseOf(this)},o.prototype.setOrtho=function(e,t,r,n,i,a){var s=void 0,o=void 0,u=void 0,l=void 0;if(e===t||r===n||i===a)throw"null frustum";return o=1/(t-e),u=1/(n-r),l=1/(a-i),s=this.elements,s[0]=2*o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2*l,s[11]=0,s[12]=-(t+e)*o,s[13]=-(n+r)*u,s[14]=-(a+i)*l,s[15]=1,this},o.prototype.ortho=function(e,t,r,n,i,a){return this.concat((new o).setOrtho(e,t,r,n,i,a))},o.prototype.setPerspective=function(e,t,r,n){var i=void 0,a=void 0,s=void 0,o=void 0;if(r===n||0===t)throw"null frustum";if(r<=0)throw"near <= 0";if(n<=0)throw"far <= 0";if(e=Math.PI*e/180/2,0===(s=Math.sin(e)))throw"null frustum";return a=1/(n-r),o=Math.cos(e)/s,i=this.elements,i[0]=o/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-(n+r)*a,i[11]=-1,i[12]=0,i[13]=0,i[14]=-2*r*n*a,i[15]=0,this},o.prototype.perspective=function(e,t,r,n){return this.concat((new o).setPerspective(e,t,r,n))},o.prototype.multiplyVector4=function(e){var t=this.elements,r=e.elements,n=new l,i=n.elements;return i[0]=r[0]*t[0]+r[1]*t[4]+r[2]*t[8]+r[3]*t[12],i[1]=r[0]*t[1]+r[1]*t[5]+r[2]*t[9]+r[3]*t[13],i[2]=r[0]*t[2]+r[1]*t[6]+r[2]*t[10]+r[3]*t[14],i[3]=r[0]*t[3]+r[1]*t[7]+r[2]*t[11]+r[3]*t[15],n},o.prototype.scale=function(e,t,r){var n=this.elements;return n[0]*=e,n[4]*=t,n[8]*=r,n[1]*=e,n[5]*=t,n[9]*=r,n[2]*=e,n[6]*=t,n[10]*=r,n[3]*=e,n[7]*=t,n[11]*=r,this},o.prototype.setTranslate=function(e,t,r){var n=this.elements;return n[12]=e,n[13]=t,n[14]=r,n[15]=1,this},o.prototype.translate=function(e,t,r){var n=this.elements;return n[12]+=n[0]*e+n[4]*t+n[8]*r,n[13]+=n[1]*e+n[5]*t+n[9]*r,n[14]+=n[2]*e+n[6]*t+n[10]*r,n[15]+=n[3]*e+n[7]*t+n[11]*r,this},o.prototype.getMaxScaleOnAxis=function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},o.prototype.rotate=function(e,t){var r=this.elements,n=t[0],i=t[1],a=t[2],s=Math.sqrt(n*n+i*i+a*a),o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,f=void 0,m=void 0,v=void 0,d=void 0,p=void 0,y=void 0,b=void 0,g=void 0,x=void 0,w=void 0,M=void 0,k=void 0,E=void 0,_=void 0,T=void 0,A=void 0,O=void 0,j=void 0,S=void 0;return Math.abs(s)<Number.EPSILON?null:(s=1/s,n*=s,i*=s,a*=s,o=Math.sin(e),u=Math.cos(e),l=1-u,h=r[0],c=r[1],f=r[2],m=r[3],v=r[4],d=r[5],p=r[6],y=r[7],b=r[8],g=r[9],x=r[10],w=r[11],M=n*n*l+u,k=i*n*l+a*o,E=a*n*l-i*o,_=n*i*l-a*o,T=i*i*l+u,A=a*i*l+n*o,O=n*a*l+i*o,j=i*a*l-n*o,S=a*a*l+u,r[0]=h*M+v*k+b*E,r[1]=c*M+d*k+g*E,r[2]=f*M+p*k+x*E,r[3]=m*M+y*k+w*E,r[4]=h*_+v*T+b*A,r[5]=c*_+d*T+g*A,r[6]=f*_+p*T+x*A,r[7]=m*_+y*T+w*A,r[8]=h*O+v*j+b*S,r[9]=c*O+d*j+g*S,r[10]=f*O+p*j+x*S,r[11]=m*O+y*j+w*S,this)},o.prototype.makeRotationFromQuaternion=function(e){var t=this.elements,r=e[0],n=e[1],i=e[2],a=e[3],s=r+r,o=n+n,u=i+i,l=r*s,h=r*o,c=r*u,f=n*o,m=n*u,v=i*u,d=a*s,p=a*o,y=a*u;return t[0]=1-(f+v),t[4]=h-y,t[8]=c+p,t[1]=h+y,t[5]=1-(l+v),t[9]=m-d,t[2]=c-p,t[6]=m+d,t[10]=1-(l+f),this};var u=function(e){var t=new Float32Array(3);e&&"object"===(void 0===e?"undefined":i(e))&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),this.elements=t};u.angle=function(e,t){var r=new u(e.elements),n=new u(t.elements);r.normalize(),n.normalize();var i=u.dot(r,n);return i>1?0:Math.acos(i)},u.cross=function(e,t){e=e.elements,t=t.elements;var r=e[0],n=e[1],i=e[2],a=t[0],s=t[1],o=t[2],l=new u;return l.elements[0]=n*o-i*s,l.elements[1]=i*a-r*o,l.elements[2]=r*s-n*a,l},u.dot=function(e,t){return e=e.elements,t=t.elements,e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},u.prototype.normalize=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=Math.sqrt(t*t+r*r+n*n);return i?1==i?this:(i=1/i,e[0]=t*i,e[1]=r*i,e[2]=n*i,this):(e[0]=0,e[1]=0,e[2]=0,this)},u.prototype.add=function(e){var t=this.elements;return e=e.elements,t[0]=t[0]+e[0],t[1]=t[1]+e[1],t[2]=t[2]+e[2],this},u.prototype.scale=function(e){var t=this.elements;return t[0]=t[0]*e,t[1]=t[1]*e,t[2]=t[2]*e,this},u.prototype.distanceToSquared=function(e,t,r){var n=this.elements[0]-e,i=this.elements[1]-t,a=this.elements[2]-r;return n*n+i*i+a*a},u.prototype.subtract=function(e){var t=this.elements;return e=e.elements,t[0]=t[0]-e[0],t[1]=t[1]-e[1],t[2]=t[2]-e[2],this};var l=function(e){var t=new Float32Array(4);e&&"object"===(void 0===e?"undefined":i(e))&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),this.elements=t};l.prototype.set=function(e){var t=this.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this},l.prototype.add=function(e){var t=this.elements;return e=e.elements,t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=t[3]+e[3],this},l.prototype.normalize=function(){var e=this.elements[0],t=this.elements[1],r=this.elements[2],n=this.elements[3],i=e*e+t*t+r*r+n*n;return i>0&&(i=1/Math.sqrt(i),this.elements[0]=e*i,this.elements[1]=t*i,this.elements[2]=r*i,this.elements[3]=n*i),this},u.prototype.divideScalar=function(e){return this.scale(1/e)},u.prototype.applyMatrix4=function(e){var t=this.elements[0],r=this.elements[1],n=this.elements[2],i=e.elements;this.elements[0]=i[0]*t+i[4]*r+i[8]*n+i[12],this.elements[1]=i[1]*t+i[5]*r+i[9]*n+i[13],this.elements[2]=i[2]*t+i[6]*r+i[10]*n+i[14];var a=i[3]*t+i[7]*r+i[11]*n+i[15];return this.divideScalar(a)},l.prototype.lerp=function(e,t,r){var n=this.elements,i=e[0],a=e[1],s=e[2],o=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=s+r*(t[2]-s),n[3]=o+r*(t[3]-o),this},u.prototype.lerp=function(e,t,r){var n=this.elements,i=e[0],a=e[1],s=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=s+r*(t[2]-s),this},t.Matrix2=a,t.Matrix3=s,t.Matrix4=o,t.Vector3=u,t.Vector4=l,t.Frustum=n},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t){n(this,e),this.redraw=t,document.addEventListener("wheel",this),document.addEventListener("mousedown",this),document.addEventListener("mousemove",this),document.addEventListener("mouseup",this),document.addEventListener("keyup",this),document.addEventListener("keydown",this),addEventListener("resize",this),this.position=[0,0,0]}return i(e,[{key:"handleEvent",value:function(e){switch(e.type){case"wheel":this.zoom(e);break;case"mousedown":this.onStart(e);break;case"mousemove":this.onMove(e);break;case"mouseup":this.onEnd(e);break;case"keyup":this.onKeyUp(e);break;case"keydown":this.onKeyDown(e);break;case"resize":this.onResize(e)}}},{key:"onResize",value:function(){this.redraw("resize")}},{key:"onKeyDown",value:function(e){(e.shiftKey||e.ctrlKey)&&(this.isPan=!0)}},{key:"onKeyUp",value:function(){this.isPan=!1}},{key:"onStart",value:function(e){this.x=e.clientX,this.y=e.clientY,this.isDrag=!0}},{key:"onMove",value:function(e){this.isDrag&&(this.isPan?this.redraw("pan",[this.x,this.y],[e.clientX,e.clientY]):this.redraw("rotate",[this.x,this.y],[e.clientX,e.clientY]),this.x=e.clientX,this.y=e.clientY)}},{key:"onEnd",value:function(){this.isDrag=!1}},{key:"zoom",value:function(e){this.zoom.v||(this.zoom.v=0),this.zoom.v=Math.min(this.zoom.v+e.deltaY,1250),this.redraw("zoom",Math.pow(1.001,this.zoom.v))}}]),e}();t.Events=a},function(e,t,r){"use strict";function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=t.Bone=t.SkinnedMesh=t.Mesh=t.Object3D=t.Scene=void 0;var o=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)},u=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(0),h=function(){function e(t,r){s(this,e),this.uuid=Math.floor(Date.now()*Math.random()),this.name=t,this.children=[],this.matrix=new l.Matrix4,this.matrixWorld=new l.Matrix4,this.matrixAnimation=new l.Matrix4,this.parent=r}return u(e,[{key:"setPosition",value:function(e,t,r){var n,i;this.hasPosition=!0,this.matrix.makeRotationFromQuaternion(t),(n=this.matrix).scale.apply(n,a(r)),(i=this.matrix).setTranslate.apply(i,a(e)),this.matrixAnimation.set(this.matrix.elements)}},{key:"setMatrix",value:function(e){this.matrix.set(e),this.matrixAnimation.set(e)}},{key:"setMatrixWorld",value:function(e){this.matrixWorld.set(e)}}]),e}(),c=function(e){function t(e,r){s(this,t);var i=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return i.geometry={boundingSphere:{center:new l.Vector3,radius:null,min:null,max:null}},i.material={},i.program=null,i.mode=4,i}return i(t,e),u(t,[{key:"setBlend",value:function(e){this.material.blend=e}},{key:"calculateBounding",value:function(){for(var e=this.geometry.attributes.a_position.value,t=0,r=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],i=0;i<e.length;i+=3){var a=e[i],s=e[i+1],o=e[i+2];r[0]=Math.min(r[0],a),r[1]=Math.min(r[1],s),r[2]=Math.min(r[2],o),n[0]=Math.max(n[0],a),n[1]=Math.max(n[1],s),n[2]=Math.max(n[2],o)}this.geometry.boundingSphere.min=new l.Vector3(r),this.geometry.boundingSphere.max=new l.Vector3(n),this.geometry.boundingSphere.center.add(this.geometry.boundingSphere.min).add(this.geometry.boundingSphere.max).scale(.5);for(var u=0;u<e.length;u+=3)t=Math.max(t,this.geometry.boundingSphere.center.distanceToSquared(e[u],e[u+1],e[u+2]));this.geometry.boundingSphere.radius=Math.sqrt(t)}},{key:"setIndicesBuffer",value:function(e){this.geometry.indicesBuffer=e}},{key:"setAttributes",value:function(e){this.geometry.attributes=e,this.calculateBounding()}},{key:"setTextures",value:function(e){this.material.texture=e}},{key:"setUniforms",value:function(e){this.material.uniforms=e}},{key:"setTechnique",value:function(e){this.material.technique=e}},{key:"setProgram",value:function(e){this.program=e}},{key:"setMode",value:function(e){this.mode=e}},{key:"getJointMatrix",value:function(){for(var e=this.material.uniforms.u_jointMat.value,t=new l.Matrix4(this.matrixWorld).invert(),r=[],n=0;n<e.length;n++){var i=new l.Matrix4(e[n]).multiply(t).multiply(this.bones[n].matrixWorld).multiply(this.boneInverses[n]).multiply(this.bindShapeMatrix);r.push(i)}return r}},{key:"getModelViewProjMatrix",value:function(e){var t=new l.Matrix4;return t.multiply(e.projection),t.multiply(e.matrixWorldInvert),t.multiply(this.matrixWorld),t}},{key:"getViewMatrix",value:function(e){var t=new l.Matrix4;return t.multiply(e.matrixWorldInvert),t}},{key:"getModelViewMatrix",value:function(e,t){var r=new l.Matrix4;return r.multiply(t.matrixWorldInvert),r.multiply(e||this.matrixWorld),r}},{key:"getProjectionMatrix",value:function(e){return e.projection}},{key:"getNormalMatrix",value:function(){var e=new l.Matrix3;return e.normalFromMat4(this.material.uniforms.u_modelViewMatrix.value),e}},{key:"isVisible",value:function(e){var t=new l.Vector3(this.geometry.boundingSphere.center.elements).applyMatrix4(this.matrixWorld),r=this.geometry.boundingSphere.radius*this.matrixWorld.getMaxScaleOnAxis(),n=void 0,i=!0,a=!0,s=!1,o=void 0;try{for(var u,h=e[Symbol.iterator]();!(a=(u=h.next()).done);a=!0){var c=u.value;if((n=c.elements[0]*t.elements[0]+c.elements[1]*t.elements[1]+c.elements[2]*t.elements[2]+c.elements[3])<-r){i=!1;break}}}catch(e){s=!0,o=e}finally{try{!a&&h.return&&h.return()}finally{if(s)throw o}}return this.distance=n+r,i}}]),t}(h),f=function(e){function t(e,r){return s(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return i(t,e),u(t,[{key:"setSkin",value:function(e){this.skin=e}}]),t}(c),m=function(e){function t(e,r){return s(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return i(t,e),u(t,[{key:"setJointName",value:function(e){this.jointName=e}}]),t}(h),v=function(e){function t(e,r){s(this,t);var i=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return i.matrixWorldInvert=new l.Matrix4,i.projection=new l.Matrix4,i}return i(t,e),u(t,[{key:"setProjection",value:function(e){this.projection.set(e)}},{key:"setMatrixWorld",value:function(e){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setMatrixWorld",this).call(this,e),this.matrixWorldInvert.setInverseOf(this.matrixWorld)}},{key:"setZ",value:function(e){this.matrix.elements[14]=e,this.setMatrixWorld(this.matrix.elements)}},{key:"getViewProjMatrix",value:function(){var e=new l.Matrix4;return e.multiply(this.projection),e.multiply(this.matrixWorldInvert),e}}]),t}(h),d=function e(){s(this,e),this.children=[],this.program=[],this.matrixWorld=new l.Matrix4,this.bin=[]};t.Scene=d,t.Object3D=h,t.Mesh=c,t.SkinnedMesh=f,t.Bone=m,t.Camera=v},function(e,t,r){"use strict";function n(e){p=e}function i(e){return"FLOAT_MAT4"===p[e]||"FLOAT_MAT3"===p[e]||"FLOAT_MAT2"===p[e]}function a(e){return"FLOAT_MAT4"===p[e]?d.Matrix4:"FLOAT_MAT3"===p[e]?d.Matrix3:"FLOAT_MAT2"===p[e]?d.Matrix2:void 0}function s(e){var t=void 0;switch(e){case"MAT2":t=4;break;case"MAT3":t=9;break;case"MAT4":t=16;break;case"VEC4":t=4;break;case"VEC3":t=3;break;case"VEC2":t=2;break;case"SCALAR":t=1}return t}function o(e){var t=void 0;switch(p[e]){case"FLOAT_VEC4":t=4;break;case"FLOAT_VEC3":t=3;break;case"FLOAT_VEC2":t=2}return t}function u(e){var t=void 0;switch(p[e]){case"FLOAT_VEC2":t="uniform2f";break;case"FLOAT_VEC4":t="uniform4f";break;case"FLOAT":t="uniform1f";break;case"FLOAT_VEC3":t="uniform3f";break;case"FLOAT_MAT4":t="uniformMatrix4fv";break;case"FLOAT_MAT3":t="uniformMatrix3fv";break;case"FLOAT_MAT2":t="uniformMatrix2fv";break;case"SAMPLER_2D":t="uniform1i"}return t}function l(e){return"rotation"===e?4:3}function h(e){return"rotation"===e?"makeRotationFromQuaternion":"scale"===e?"scale":"translation"===e?"setTranslate":void 0}function c(e,t,r){return(r-e)/(t-e)}function f(e,t){if(0===t.length)return[-1,-1,0];for(var r=-1,n=t.length-1;n>=0;n--)if(e>=t[n].time){r=n;break}if(-1===r||r===t.length-1)return r<0&&(r=0),[r,r,0];var i=t[r],a=t[r+1];return e=Math.max(i.time,Math.min(e,a.time)),[r,r+1,c(i.time,a.time,e)]}function m(e,t,r,n){var i=void 0;switch(p[t]){case"BYTE":i=new Int8Array(e,r,n);break;case"UNSIGNED_BYTE":i=new Uint8Array(e,r,n);break;case"SHORT":i=new Int16Array(e,r,n);break;case"UNSIGNED_SHORT":i=new Uint16Array(e,r,n);break;case"FLOAT":i=new Float32Array(e,r,n)}return i}function v(e){return e*Math.PI/180}Object.defineProperty(t,"__esModule",{value:!0}),t.setGl=n,t.isMatrix=i,t.getMatrixType=a,t.getDataType=s,t.getComponentType=o,t.getMethod=u,t.getAnimationComponent=l,t.getAnimationMethod=h,t.range=c,t.interpolation=f,t.buildArray=m,t.degToRad=v;var d=r(0),p=void 0},function(e,t,r){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.RedCube=void 0;var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(2),o=r(0),u=r(1),l=r(3),h=void 0,c=function(){function e(t,r){i(this,e),this.reflow=!0,this.scene=new s.Scene,this.color=[.6,.6,.6,1],this.url=t,this.host=t.substr(0,t.lastIndexOf("/")+1),this.canvas=r,this.aspect=this.canvas.offsetWidth/this.canvas.offsetHeight,this.cameras=[],this._camera=new s.Camera,this._camera.props={type:"perspective",perspective:{yfov:null,znear:1,zfar:2e6,aspectRatio:null}},this.zoom=1,this._camera.setZ(5),this.unblendEnable={},this.blendEnable={},this.blendTechnique={},this.tracks=[],this.skins={},this.json=null,this.glEnum={},this.textures={},this.events=new u.Events(this.redraw.bind(this)),this.cameraPosition=new o.Vector3([0,0,.05])}return a(e,[{key:"redraw",value:function(e,t,r){if("zoom"===e&&(this.zoom=t,this._camera.setProjection(this.buildCamera(this._camera.props).elements)),"rotate"===e){var i=r[0]-t[0],a=new o.Matrix4;a.rotate((0,l.degToRad)(-i/5),[0,1,0]);var s=r[1]-t[1];a.rotate((0,l.degToRad)(-s/5),[1,0,0]),this._camera.matrix.multiply(a),this._camera.setMatrixWorld(this._camera.matrix.elements)}if("pan"===e){var u=new o.Vector3(this.canvasToWorld.apply(this,n(t)).elements),h=new o.Vector3(this.canvasToWorld.apply(this,n(r)).elements),c=100*this._camera.modelSize,f=h.subtract(u).scale(c);this._camera.matrix.translate(f.elements[0],f.elements[1],0),this._camera.setMatrixWorld(this._camera.matrix.elements)}"resize"===e&&this.resize(),this.reflow=!0}},{key:"resize",value:function(){this.aspect=this.canvas.offsetWidth/this.canvas.offsetHeight,this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,h.viewport(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this._camera.setProjection(this.buildCamera(this._camera.props).elements)}},{key:"sceneToArcBall",value:function(e){var t=e.elements[0]*e.elements[0]+e.elements[1]*e.elements[1],r=.0016-t;return r>0?[e.elements[0],e.elements[1],Math.sqrt(r)]:(t=Math.sqrt(t),[.04*e.elements[0]/t,.04*e.elements[1]/t,0])}},{key:"canvasToWorld",value:function(e,t){var r=new o.Matrix4;r.setTranslate.apply(r,n(this.cameraPosition.elements));var i=new o.Matrix4(this._camera.projection);i.multiply(r);var a=i.multiplyVector4(new o.Vector4([0,0,0,1]));return a.elements[0]=(2*e/this.canvas.offsetWidth-1)*a.elements[3],a.elements[1]=(-2*t/this.canvas.offsetHeight+1)*a.elements[3],i.invert().multiplyVector4(a)}},{key:"init",value:function(){return this.getJson().then(this.glInit.bind(this)).then(this.getBuffer.bind(this)).then(this.buildMesh.bind(this)).then(this.initTextures.bind(this)).then(this.buildAnimation.bind(this)).then(this.buildSkin.bind(this)).then(this.draw.bind(this)).catch(console.error)}},{key:"setColor",value:function(e){this.color=e}},{key:"walk",value:function(e,t){function r(e){t(e),e.children&&e.children.forEach(r)}r(e)}},{key:"getBuffer",value:function(){var e=this;return fetch(""+this.host+this.scene.bin[0]).then(function(e){return e.arrayBuffer()}).then(function(t){return e.arrayBuffer=t,!0})}},{key:"buildPrim",value:function(e,t,r,n){var i=this,a=this.json.accessors[n.indices],o={};for(var u in n.attributes)o[u.toLowerCase().replace(/_(\d)/,"$1")]=this.json.accessors[n.attributes[u]];var c=this.json.materials[n.material].values,f=this.json.materials[n.material].technique,m=this.json.techniques[f],v={};for(var d in m.attributes)v[d]={type:m.parameters[m.attributes[d]].type,semantic:m.parameters[m.attributes[d]].semantic};var p={};for(var y in m.uniforms){var b=m.parameters[m.uniforms[y]],g=b.node,x=b.value;g&&(g=this.json.nodes[g].matrix),p[y]={type:b.type,value:x,semantic:b.semantic,node:g,count:b.count}}for(var w in c)void 0!==c[w]&&(p["u_"+w].value=c[w]);var M=[];for(var k in p){var E=p[k];if(E.type===h.SAMPLER_2D){var _=Object.assign({},this.json.textures[E.value]);Object.assign(_,this.json.samplers[_.sampler]),Object.assign(_,this.json.images[_.source]),M.push(_)}if(void 0===E.value||Array.isArray(E.value)||(E.value=[E.value]),void 0===E.node||Array.isArray(E.node)||(E.node=[E.node]),E.value&&(0,l.isMatrix)(E.type)){var T=(0,l.getMatrixType)(E.type);E.value=(new T).set(E.value)}if(E.node&&(0,l.isMatrix)(E.type)){var A=(0,l.getMatrixType)(E.type);E.node=(new A).set(E.node)}E.count&&!E.value&&function(){var e=(0,l.getMatrixType)(E.type);E.value=new Array(E.count).fill(1).map(function(){return new e})}()}var O=void 0;if(a){O={};var j=this.json.bufferViews[a.bufferView];O.value=(0,l.buildArray)(this.arrayBuffer,a.componentType,j.byteOffset+a.byteOffset,(0,l.getDataType)(a.type)*a.count)}for(var S in o)if(v["a_"+S]){var P=o[S],R=this.json.bufferViews[P.bufferView];v["a_"+S].value=(0,l.buildArray)(this.arrayBuffer,P.componentType,R.byteOffset+P.byteOffset,(0,l.getDataType)(P.type)*P.count)}var F=void 0;t.skin?(F=new s.SkinnedMesh(r,e),F.setSkin(t.skin)):F=new s.Mesh(r,e);var V=m.states.enable.some(function(e){return"BLEND"===i.glEnum[e]});if(V){F.setBlend(V),Object.assign(this.blendTechnique,m.states.functions);var I=!0,B=!1,W=void 0;try{for(var L,z=m.states.enable[Symbol.iterator]();!(I=(L=z.next()).done);I=!0){var C=L.value;this.blendEnable[C]=!0}}catch(e){B=!0,W=e}finally{try{!I&&z.return&&z.return()}finally{if(B)throw W}}}else{var N=!0,D=!1,U=void 0;try{for(var q,Y=m.states.enable[Symbol.iterator]();!(N=(q=Y.next()).done);N=!0){var H=q.value;this.unblendEnable[H]=!0}}catch(e){D=!0,U=e}finally{try{!N&&Y.return&&Y.return()}finally{if(D)throw U}}}return F.setTechnique(m.states),F.setProgram(this.scene.program.find(function(e){return e.name===m.program}).program),F.setMode(n.mode),F.setUniforms(p),F.setAttributes(v),F.setIndicesBuffer(O),F.setTextures(M),F}},{key:"calculateFov",value:function(){var e=void 0;this.walk(this.scene,function(t){(t instanceof s.SkinnedMesh||t instanceof s.Mesh)&&(e||(e=t),t.geometry.boundingSphere.radius>e.geometry.boundingSphere.radius&&(e=t))});var t=Math.abs,r=e.geometry.boundingSphere.min.elements,n=e.geometry.boundingSphere.max.elements;if(this._camera.modelXSize=Math.max(t(r[0]),t(r[2]),t(n[0]),t(n[2]),Math.sqrt(r[0]*r[0]+r[2]*r[2]),Math.sqrt(n[0]*n[0]+n[2]*n[2])),this._camera.modelYSize=Math.max(t(r[1]),t(r[2]),t(n[1]),t(n[2])),this._camera.modelSize=Math.max(this._camera.modelYSize,this._camera.modelXSize),!this._camera.props.perspective.yfov){console.warn("Camera not found");var i=this._camera.modelSize/(this.canvas.offsetWidth/100)*100;this._camera.setZ(i),this._camera.props.perspective.yfov=.6}this.resize()}},{key:"buildCamera",value:function(e){var t=void 0;if("perspective"===e.type&&e.perspective){var r=e.perspective.yfov,n=e.perspective.aspectRatio||this.aspect,i=r*this.aspect;this.aspect!==n&&console.warn("this.canvas size and this.canvas size from scene dont equal"),t=(new o.Matrix4).setPerspective(i*this.zoom*(180/Math.PI),this.aspect,e.perspective.znear||1,e.perspective.zfar||2e6)}else"orthographic"===e.type&&e.orthographic&&(t=(new o.Matrix4).setOrtho(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar));return t}},{key:"walkByMesh",value:function(e,t){var r=this,i=this.json.nodes[t],a=void 0;if(i.camera){var o=this.buildCamera(this.json.cameras[i.camera]);a=new s.Camera(t,e),a.props=this.json.cameras[i.camera],a.setProjection(o.elements),a.setMatrix(i.matrix),a.setMatrixWorld(i.matrix),this._camera=a,this.cameras.push(a)}else i.jointName?(a=new s.Bone(t,e),a.setJointName(i.jointName)):a=new s.Object3D(t,e),i.translation&&i.rotation&&i.scale?a.setPosition(i.translation,i.rotation,i.scale):i.matrix&&a.setMatrix(i.matrix);e.children.push(a),e=a,i.children&&i.children.length?i.children.forEach(this.walkByMesh.bind(this,e)):i.meshes&&i.meshes.length&&i.meshes.forEach(function(t){var a;(a=e.children).push.apply(a,n(r.json.meshes[t].primitives.map(r.buildPrim.bind(r,e,i,t))))})}},{key:"buildMesh",value:function(){var e=this;return this.json.scenes.defaultScene.nodes.forEach(function(t){if(e.json.nodes[t].children.length&&e.walkByMesh(e.scene,t),e.json.nodes[t].meshes&&e.json.nodes[t].meshes.length&&e.json.nodes[t].meshes.forEach(function(r){var i;(i=e.scene.children).push.apply(i,n(e.json.meshes[r].primitives.map(e.buildPrim.bind(e,e.scene,e.json.nodes[t],r))))}),e.json.nodes[t].camera){var r=e.buildCamera(e.json.cameras[e.json.nodes[t].camera]);e._camera=new s.Camera,e._camera.props=e.json.cameras[e.json.nodes[t].camera],e._camera.setProjection(r.elements),e._camera.setMatrix(e.json.nodes[t].matrix),e._camera.setMatrixWorld(e.json.nodes[t].matrix)}}),this.calculateFov(),!0}},{key:"buildAnimation",value:function(){var e=this;for(var t in this.json.animations){var r=this.json.animations[t];for(var n in r.channels){var i=r.channels[n],a=r.samplers[i.sampler];a&&function(){for(var t=i.target,n=t.id,s=void 0!==r.parameters?r.parameters[a.input]:a.input,o=void 0!==r.parameters?r.parameters[a.output]:a.output,u=e.json.accessors[s],h=e.json.accessors[o],c=e.json.bufferViews[u.bufferView],f=e.json.bufferViews[h.bufferView],m=(0,l.buildArray)(e.arrayBuffer,u.componentType,c.byteOffset+u.byteOffset,(0,l.getDataType)(u.type)*u.count),v=(0,l.buildArray)(e.arrayBuffer,h.componentType,f.byteOffset+h.byteOffset,(0,l.getDataType)(h.type)*h.count),d=(0,l.getAnimationComponent)(t.path),p=[],y=0;y<m.length;y++){var b=m[y],g=v.slice(y*d,(y+1)*d);p.push({time:b,value:g})}var x=e.json.nodes[n],w=void 0,M=void 0;!function e(t){M||(t.name+"Node"!==n&&t.name!==n||(w=t,M=!0),t.children&&t.children.forEach(e))}(e.scene),x&&e.tracks.push({mesh:w,type:t.path,name:x.name+"."+t.path,keys:p,interpolation:a.interpolation})}()}}return!0}},{key:"buildSkin",value:function(){for(var e in this.json.skins){var t=this.json.skins[e],r=new o.Matrix4;void 0!==t.bindShapeMatrix&&r.set(t.bindShapeMatrix);var n=this.json.accessors[t.inverseBindMatrices],i=this.json.bufferViews[n.bufferView],a=(0,l.buildArray)(this.arrayBuffer,n.componentType,i.byteOffset+n.byteOffset,(0,l.getDataType)(n.type)*n.count);this.skins[e]={bindShapeMatrix:r,jointNames:t.jointNames,inverseBindMatrices:a};var s=0,u=this.skins[e];u.bones=[],u.boneInverses=[];var h=!0,c=!1,f=void 0;try{for(var m,v=u.jointNames[Symbol.iterator]();!(h=(m=v.next()).done);h=!0){var d=m.value;this.walk(this.scene,this.buildBones.bind(this,d,u));var p=u.inverseBindMatrices,y=(new o.Matrix4).set(p.slice(16*s,16*(s+1)));u.boneInverses.push(y),s++}}catch(e){c=!0,f=e}finally{try{!h&&v.return&&v.return()}finally{if(c)throw f}}}return!0}},{key:"buildBones",value:function(e,t,r){r.jointName===e&&t.bones.push(r)}},{key:"getJson",value:function(){var e=this;return fetch(this.url).then(function(e){return e.json()}).then(function(t){for(var r in t.programs)t.programs[r].shaders=[],t.programs[r].name=r,e.scene.program.push(t.programs[r]);for(var n in t.buffers)e.scene.bin.push(t.buffers[n].uri);return e.json=t,!0})}},{key:"buildBuffer",value:function(e){if(e)if(e.buffer)h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,e.buffer);else{var t=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,t),h.bufferData(h.ELEMENT_ARRAY_BUFFER,e.value,h.STATIC_DRAW),e.buffer=t}for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];n.forEach(function(e){if(!e.buffer){var t=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,t),h.bufferData(h.ARRAY_BUFFER,e.value,h.STATIC_DRAW),e.buffer=t}})}},{key:"glInit",value:function(){var e=this;h=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");for(var t in h){var r=h[t];"number"==typeof r&&(this.glEnum[r]=t)}(0,l.setGl)(this.glEnum);var n=[],i=!0,a=!1,s=void 0;try{for(var o,u=this.scene.program[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var c=o.value;n.push(fetch(""+this.host+c.fragmentShader+".glsl").then(function(e){return e.text()})),n.push(fetch(""+this.host+c.vertexShader+".glsl").then(function(e){return e.text()}))}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}return Promise.all(n).then(function(t){var r=void 0,n=0,i=!0,a=!1,s=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var l=o.value;r||(r=h.createProgram());var c=void 0;c=/gl_Position/.test(l)?h.VERTEX_SHADER:h.FRAGMENT_SHADER;var f=h.createShader(c);h.shaderSource(f,l),h.compileShader(f),h.attachShader(r,f);2===e.scene.program[n].shaders.push(f)&&(e.scene.program[n].program=r,h.linkProgram(r),r=null,n++)}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}return!0})}},{key:"animate",value:function(e){var t=!0,r=!1,i=void 0;try{for(var a,s=this.tracks[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var u=a.value,h=(0,l.interpolation)(e,u.keys);if(-1!==h[0]&&-1!==h[1]&&!u.stoped){h[0]===u.keys.length-1&&(u.stoped=!0);var c=u.keys[h[0]],f=u.keys[h[1]],m=h[2],v=(0,l.getAnimationComponent)(u.type),d=3===v?o.Vector3:o.Vector4,p=new d(c.value),y=new d(f.value);if("rotation"===u.type){var b=new o.Vector4;b.lerp(p.elements,y.elements,m),u.mesh.matrixAnimation[(0,l.getAnimationMethod)(u.type)](b.elements)}else{var g,x=new o.Vector3;x.lerp(p.elements,y.elements,m),(g=u.mesh.matrixAnimation)[(0,l.getAnimationMethod)(u.type)].apply(g,n(x.elements))}this.reflow=!0}}}catch(e){r=!0,i=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw i}}}},{key:"setMesh",value:function(e,t,r){if(r.parent&&r.parent.matrixWorld){var n=new o.Matrix4;n.multiply(r.parent.matrixWorld),n.multiply(r.matrixAnimation),r.setMatrixWorld(n.elements)}r instanceof s.SkinnedMesh&&(r.bones=this.skins[r.skin].bones,r.boneInverses=this.skins[r.skin].boneInverses,r.bindShapeMatrix=this.skins[r.skin].bindShapeMatrix),(r instanceof s.SkinnedMesh||r instanceof s.Mesh)&&(r.material.blend?e.push(r):t.push(r))}},{key:"draw",value:function(){var e;(e=h).clearColor.apply(e,n(this.color)),this.render()}},{key:"render",value:function(e){var t=e/1e3;if(this.animate(t),this.reflow){h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT|h.STENSIL_BUFFER_BIT);var r=[],i=[];this.walk(this.scene,this.setMesh.bind(this,r,i));var a=(0,o.Frustum)(this._camera.getViewProjMatrix());if(i.length){for(var s in this.unblendEnable)h.enable(s);var u=!0,l=!1,c=void 0;try{for(var f,m=i[Symbol.iterator]();!(u=(f=m.next()).done);u=!0){var v=f.value;v.isVisible(a)&&(this.buildBuffer.apply(this,[v.geometry.indicesBuffer].concat(n(Object.values(v.geometry.attributes)))),this._draw(v))}}catch(e){l=!0,c=e}finally{try{!u&&m.return&&m.return()}finally{if(l)throw c}}for(var d in this.unblendEnable)h.disable(d)}if(r.length){var p=[],y=!0,b=!1,g=void 0;try{for(var x,w=r[Symbol.iterator]();!(y=(x=w.next()).done);y=!0){var M=x.value;M.isVisible(a)&&p.push(M)}}catch(e){b=!0,g=e}finally{try{!y&&w.return&&w.return()}finally{if(b)throw g}}if(p.length){p.sort(function(e,t){return e.distance-t.distance});for(var k in this.blendEnable)h.enable(k);for(var E in this.blendTechnique){var _;(_=h)[E].apply(_,n(this.blendTechnique[E]))}var T=!0,A=!1,O=void 0;try{for(var j,S=p[Symbol.iterator]();!(T=(j=S.next()).done);T=!0){var P=j.value;this.buildBuffer.apply(this,[P.geometry.indicesBuffer].concat(n(Object.values(P.geometry.attributes)))),this._draw(P)}}catch(e){A=!0,O=e}finally{try{!T&&S.return&&S.return()}finally{if(A)throw O}}for(var R in this.blendEnable)h.disable(R);for(var F in this.blendTechnique)"depthMask"===F&&h[F](!0),"blendFuncSeparate"===F&&h[F](h.ONE,h.ZERO,h.ONE,h.ZERO),"blendEquationSeparate"===F&&h[F](h.FUNC_ADD,h.FUNC_ADD)}}}this.reflow=!1,requestAnimationFrame(this.render.bind(this))}},{key:"_draw",value:function(e){h.useProgram(e.program);var t=this._camera;for(var r in e.geometry.attributes){var i=e.geometry.attributes[r];h.bindBuffer(h.ARRAY_BUFFER,i.buffer);var a=void 0;if(void 0!==i[r])a=i[r];else{if(0!==(a=h.getAttribLocation(e.program,r))&&!a){console.warn("dont get "+r+" from shader"),delete e.geometry.attributes[r];continue}i[r]=a,h.enableVertexAttribArray(a)}h.vertexAttribPointer(a,(0,l.getComponentType)(i.type),h.FLOAT,!1,0,0)}var s=0;for(var u in e.material.uniforms){var c=e.material.uniforms[u],f=void 0;switch(c.type===h.SAMPLER_2D&&(h.activeTexture(h["TEXTURE"+s]),h.bindTexture(e.material.texture[s].target,this.textures[e.material.texture[s].name].data),c.value=[s],s++),c.semantic){case"MODELVIEWPROJECTION":c.value=e.getModelViewProjMatrix(t);break;case"MODELVIEWPROJECTIONINVERSE":c.value=e.getModelViewProjMatrix(t).invert();break;case"VIEW":c.value=e.getViewMatrix(t);break;case"VIEWINVERSE":c.value=e.getViewMatrix(t).invert();break;case"MODEL":c.value=e.matrixWorld;break;case"MODELINVERSETRANSPOSE":c.value=(new o.Matrix3).normalFromMat4(e.matrixWorld);break;case"MODELINVERSE":c.value=new o.Matrix4(e.matrixWorld).invert();break;case"MODELVIEW":c.value=e.getModelViewMatrix(c.node,t);break;case"MODELVIEWINVERSE":c.value=e.getModelViewMatrix(c.node,t).invert();break;case"PROJECTION":c.value=e.getProjectionMatrix(t);break;case"PROJECTIONINVERSE":c.value=new o.Matrix4(e.getProjectionMatrix(t)).invert();break;case"MODELVIEWINVERSETRANSPOSE":c.value=e.getNormalMatrix();break;case"VIEWPORT":c.value=new Float32Array([0,0,this.canvas.offsetWidth,this.canvas.offsetHeight]);break;case"JOINTMATRIX":f=e.getJointMatrix()}var m=void 0;if(void 0!==c[u])m=c[u];else{if(0!==(m=h.getUniformLocation(e.program,u))&&!m){console.warn("dont get "+u+" from shader"),delete e.material.uniforms[u];continue}c[u]=m}var v=c.value||c.node;if(v.elements)h[(0,l.getMethod)(c.type)](m,!1,v.elements);else if(f){var d=new Float32Array(16*f.length),p=0,y=!0,b=!1,g=void 0;try{for(var x,w=f[Symbol.iterator]();!(y=(x=w.next()).done);y=!0){var M=x.value;d.set(M.elements,16*p),p++}}catch(e){b=!0,g=e}finally{try{!y&&w.return&&w.return()}finally{if(b)throw g}}h[(0,l.getMethod)(c.type)](m,!1,d)}else{var k;(k=h)[(0,l.getMethod)(c.type)].apply(k,[m].concat(n(v)))}}e.geometry.indicesBuffer?h.drawElements(e.mode,e.geometry.indicesBuffer.value.length,h.UNSIGNED_SHORT,0):h.drawArrays(e.mode,0,e.geometry.attributes.a_position.value.length/3)}},{key:"walkTexture",value:function(e){var t=this;e.material&&e.material.texture&&e.material.texture.forEach(function(e){t.textures[e.name]||(t.textures[e.name]=e)})}},{key:"initTextures",value:function(){var e=this;this.walk(this.scene,this.walkTexture.bind(this));var t=Object.values(this.textures).map(function(t){return new Promise(function(r,n){var i=new Image;i.onload=function(){e.handleTextureLoaded(t,i),r()},i.onerror=function(e){n(e)},i.crossOrigin="anonymous",i.src=""+e.host+t.uri})});return Promise.all(t)}},{key:"handleTextureLoaded",value:function(e,t){e.data=h.createTexture(),h.bindTexture(e.target,e.data),h.texImage2D(e.target,0,e.format,e.internalFormat,e.type,t),h.texParameteri(e.target,h.TEXTURE_WRAP_S,e.wrapS),h.texParameteri(e.target,h.TEXTURE_WRAP_T,e.wrapT),h.texParameteri(e.target,h.TEXTURE_MAG_FILTER,e.magFilter),h.texParameteri(e.target,h.TEXTURE_MIN_FILTER,e.minFilter),h.generateMipmap(e.target)}}]),e}();t.RedCube=c}])});