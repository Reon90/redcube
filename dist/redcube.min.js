!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("redcube",[],t):"object"==typeof exports?exports.redcube=t():e.redcube=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t,r){"use strict";function n(e){var t=[new u,new u,new u,new u,new u,new u],r=e.elements,n=r[0],i=r[1],a=r[2],s=r[3],o=r[4],l=r[5],h=r[6],c=r[7],m=r[8],f=r[9],v=r[10],d=r[11],p=r[12],y=r[13],b=r[14],x=r[15];return t[0].set([s-n,c-o,d-m,x-p]).normalize(),t[1].set([s+n,c+o,d+m,x+p]).normalize(),t[2].set([s+i,c+l,d+f,x+y]).normalize(),t[3].set([s-i,c-l,d-f,x-y]).normalize(),t[4].set([s-a,c-h,d-v,x-b]).normalize(),t[5].set([s+a,c+h,d+v,x+b]).normalize(),t}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(e){var t,r,n;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(4),t=0;t<4;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,1])};a.prototype.set=function(e){var t,r,n;if(r=e,n=this.elements,r!==n){for(t=0;t<4;++t)n[t]=r[t];return this}};var s=function(e){var t,r,n;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(9),t=0;t<9;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])};s.prototype.set=function(e){var t,r,n;if(r=e,n=this.elements,r!==n){for(t=0;t<9;++t)n[t]=r[t];return this}},s.prototype.normalFromMat4=function(e){var t=this.elements;e=e.elements;var r=e[0],n=e[1],i=e[2],a=e[3],s=e[4],o=e[5],l=e[6],u=e[7],h=e[8],c=e[9],m=e[10],f=e[11],v=e[12],d=e[13],p=e[14],y=e[15],b=r*o-n*s,x=r*l-i*s,w=r*u-a*s,g=n*l-i*o,M=n*u-a*o,k=i*u-a*l,E=h*d-c*v,A=h*p-m*v,T=h*y-f*v,_=c*p-m*d,O=c*y-f*d,j=m*y-f*p,S=b*j-x*O+w*_+g*T-M*A+k*E;return S?(S=1/S,t[0]=(o*j-l*O+u*_)*S,t[1]=(l*T-s*j-u*A)*S,t[2]=(s*O-o*T+u*E)*S,t[3]=(i*O-n*j-a*_)*S,t[4]=(r*j-i*T+a*A)*S,t[5]=(n*T-r*O-a*E)*S,t[6]=(d*k-p*M+y*g)*S,t[7]=(p*w-v*k-y*x)*S,t[8]=(v*M-d*w+y*b)*S,this):null};var o=function(e){var t,r,n;if(e&&"object"===(void 0===e?"undefined":i(e))&&e.hasOwnProperty("elements")){for(r=e.elements,n=new Float32Array(16),t=0;t<16;++t)n[t]=r[t];this.elements=n}else this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])};o.prototype.set=function(e){var t,r,n;if(r=e,n=this.elements,r!==n){for(t=0;t<16;++t)n[t]=r[t];return this}},o.prototype.concat=function(e){var t,r,n,i,a,s,o,l;if(r=this.elements,n=this.elements,i=e.elements,r===i)for(i=new Float32Array(16),t=0;t<16;++t)i[t]=r[t];for(t=0;t<4;t++)a=n[t],s=n[t+4],o=n[t+8],l=n[t+12],r[t]=a*i[0]+s*i[1]+o*i[2]+l*i[3],r[t+4]=a*i[4]+s*i[5]+o*i[6]+l*i[7],r[t+8]=a*i[8]+s*i[9]+o*i[10]+l*i[11],r[t+12]=a*i[12]+s*i[13]+o*i[14]+l*i[15];return this},o.prototype.multiply=o.prototype.concat,o.prototype.setInverseOf=function(e){var t,r,n,i,a;if(r=e.elements,n=this.elements,i=new Float32Array(16),i[0]=r[5]*r[10]*r[15]-r[5]*r[11]*r[14]-r[9]*r[6]*r[15]+r[9]*r[7]*r[14]+r[13]*r[6]*r[11]-r[13]*r[7]*r[10],i[4]=-r[4]*r[10]*r[15]+r[4]*r[11]*r[14]+r[8]*r[6]*r[15]-r[8]*r[7]*r[14]-r[12]*r[6]*r[11]+r[12]*r[7]*r[10],i[8]=r[4]*r[9]*r[15]-r[4]*r[11]*r[13]-r[8]*r[5]*r[15]+r[8]*r[7]*r[13]+r[12]*r[5]*r[11]-r[12]*r[7]*r[9],i[12]=-r[4]*r[9]*r[14]+r[4]*r[10]*r[13]+r[8]*r[5]*r[14]-r[8]*r[6]*r[13]-r[12]*r[5]*r[10]+r[12]*r[6]*r[9],i[1]=-r[1]*r[10]*r[15]+r[1]*r[11]*r[14]+r[9]*r[2]*r[15]-r[9]*r[3]*r[14]-r[13]*r[2]*r[11]+r[13]*r[3]*r[10],i[5]=r[0]*r[10]*r[15]-r[0]*r[11]*r[14]-r[8]*r[2]*r[15]+r[8]*r[3]*r[14]+r[12]*r[2]*r[11]-r[12]*r[3]*r[10],i[9]=-r[0]*r[9]*r[15]+r[0]*r[11]*r[13]+r[8]*r[1]*r[15]-r[8]*r[3]*r[13]-r[12]*r[1]*r[11]+r[12]*r[3]*r[9],i[13]=r[0]*r[9]*r[14]-r[0]*r[10]*r[13]-r[8]*r[1]*r[14]+r[8]*r[2]*r[13]+r[12]*r[1]*r[10]-r[12]*r[2]*r[9],i[2]=r[1]*r[6]*r[15]-r[1]*r[7]*r[14]-r[5]*r[2]*r[15]+r[5]*r[3]*r[14]+r[13]*r[2]*r[7]-r[13]*r[3]*r[6],i[6]=-r[0]*r[6]*r[15]+r[0]*r[7]*r[14]+r[4]*r[2]*r[15]-r[4]*r[3]*r[14]-r[12]*r[2]*r[7]+r[12]*r[3]*r[6],i[10]=r[0]*r[5]*r[15]-r[0]*r[7]*r[13]-r[4]*r[1]*r[15]+r[4]*r[3]*r[13]+r[12]*r[1]*r[7]-r[12]*r[3]*r[5],i[14]=-r[0]*r[5]*r[14]+r[0]*r[6]*r[13]+r[4]*r[1]*r[14]-r[4]*r[2]*r[13]-r[12]*r[1]*r[6]+r[12]*r[2]*r[5],i[3]=-r[1]*r[6]*r[11]+r[1]*r[7]*r[10]+r[5]*r[2]*r[11]-r[5]*r[3]*r[10]-r[9]*r[2]*r[7]+r[9]*r[3]*r[6],i[7]=r[0]*r[6]*r[11]-r[0]*r[7]*r[10]-r[4]*r[2]*r[11]+r[4]*r[3]*r[10]+r[8]*r[2]*r[7]-r[8]*r[3]*r[6],i[11]=-r[0]*r[5]*r[11]+r[0]*r[7]*r[9]+r[4]*r[1]*r[11]-r[4]*r[3]*r[9]-r[8]*r[1]*r[7]+r[8]*r[3]*r[5],i[15]=r[0]*r[5]*r[10]-r[0]*r[6]*r[9]-r[4]*r[1]*r[10]+r[4]*r[2]*r[9]+r[8]*r[1]*r[6]-r[8]*r[2]*r[5],0===(a=r[0]*i[0]+r[1]*i[4]+r[2]*i[8]+r[3]*i[12]))return this;for(a=1/a,t=0;t<16;t++)n[t]=i[t]*a;return this},o.prototype.invert=function(){return this.setInverseOf(this)},o.prototype.setOrtho=function(e,t,r,n,i,a){var s,o,l,u;if(e===t||r===n||i===a)throw"null frustum";return o=1/(t-e),l=1/(n-r),u=1/(a-i),s=this.elements,s[0]=2*o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=2*l,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=-2*u,s[11]=0,s[12]=-(t+e)*o,s[13]=-(n+r)*l,s[14]=-(a+i)*u,s[15]=1,this},o.prototype.ortho=function(e,t,r,n,i,a){return this.concat((new o).setOrtho(e,t,r,n,i,a))},o.prototype.setPerspective=function(e,t,r,n){var i,a,s,o;if(r===n||0===t)throw"null frustum";if(r<=0)throw"near <= 0";if(n<=0)throw"far <= 0";if(e=Math.PI*e/180/2,0===(s=Math.sin(e)))throw"null frustum";return a=1/(n-r),o=Math.cos(e)/s,i=this.elements,i[0]=o/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-(n+r)*a,i[11]=-1,i[12]=0,i[13]=0,i[14]=-2*r*n*a,i[15]=0,this},o.prototype.perspective=function(e,t,r,n){return this.concat((new o).setPerspective(e,t,r,n))},o.prototype.multiplyVector4=function(e){var t=this.elements,r=e.elements,n=new u,i=n.elements;return i[0]=r[0]*t[0]+r[1]*t[4]+r[2]*t[8]+r[3]*t[12],i[1]=r[0]*t[1]+r[1]*t[5]+r[2]*t[9]+r[3]*t[13],i[2]=r[0]*t[2]+r[1]*t[6]+r[2]*t[10]+r[3]*t[14],i[3]=r[0]*t[3]+r[1]*t[7]+r[2]*t[11]+r[3]*t[15],n},o.prototype.scale=function(e,t,r){var n=this.elements;return n[0]*=e,n[4]*=t,n[8]*=r,n[1]*=e,n[5]*=t,n[9]*=r,n[2]*=e,n[6]*=t,n[10]*=r,n[3]*=e,n[7]*=t,n[11]*=r,this},o.prototype.setTranslate=function(e,t,r){var n=this.elements;return n[12]=e,n[13]=t,n[14]=r,n[15]=1,this},o.prototype.translate=function(e,t,r){var n=this.elements;return n[12]+=n[0]*e+n[4]*t+n[8]*r,n[13]+=n[1]*e+n[5]*t+n[9]*r,n[14]+=n[2]*e+n[6]*t+n[10]*r,n[15]+=n[3]*e+n[7]*t+n[11]*r,this},o.prototype.setLookAt=function(e,t,r,n,i,a,s,o,l){var u,h,c,m,f,v,d,p,y,b,x,w;return h=n-e,c=i-t,m=a-r,f=1/Math.sqrt(h*h+c*c+m*m),h*=f,c*=f,m*=f,v=c*l-m*o,d=m*s-h*l,p=h*o-c*s,y=1/Math.sqrt(v*v+d*d+p*p),v*=y,d*=y,p*=y,b=d*m-p*c,x=p*h-v*m,w=v*c-d*h,u=this.elements,u[0]=v,u[1]=b,u[2]=-h,u[3]=0,u[4]=d,u[5]=x,u[6]=-c,u[7]=0,u[8]=p,u[9]=w,u[10]=-m,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,this.translate(-e,-t,-r)},o.prototype.lookAt=function(e,t,r,n,i,a,s,l,u){return this.concat((new o).setLookAt(e,t,r,n,i,a,s,l,u))},o.prototype.getMaxScaleOnAxis=function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},o.prototype.makeRotationFromQuaternion=function(e){var t=this.elements,r=e[0],n=e[1],i=e[2],a=e[3],s=r+r,o=n+n,l=i+i,u=r*s,h=r*o,c=r*l,m=n*o,f=n*l,v=i*l,d=a*s,p=a*o,y=a*l;return t[0]=1-(m+v),t[4]=h-y,t[8]=c+p,t[1]=h+y,t[5]=1-(u+v),t[9]=f-d,t[2]=c-p,t[6]=f+d,t[10]=1-(u+m),this};var l=function(e){var t=new Float32Array(3);e&&"object"===(void 0===e?"undefined":i(e))&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),this.elements=t};l.angle=function(e,t){var r=new l(e.elements),n=new l(t.elements);r.normalize(),n.normalize();var i=l.dot(r,n);return i>1?0:Math.acos(i)},l.cross=function(e,t){e=e.elements,t=t.elements;var r=e[0],n=e[1],i=e[2],a=t[0],s=t[1],o=t[2],u=new l;return u.elements[0]=n*o-i*s,u.elements[1]=i*a-r*o,u.elements[2]=r*s-n*a,u},l.dot=function(e,t){return e=e.elements,t=t.elements,e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},l.prototype.normalize=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=Math.sqrt(t*t+r*r+n*n);return i?1==i?this:(i=1/i,e[0]=t*i,e[1]=r*i,e[2]=n*i,this):(e[0]=0,e[1]=0,e[2]=0,this)},l.prototype.add=function(e){var t=this.elements;return e=e.elements,t[0]=t[0]+e[0],t[1]=t[1]+e[1],t[2]=t[2]+e[2],this},l.prototype.scale=function(e){var t=this.elements;return t[0]=t[0]*e,t[1]=t[1]*e,t[2]=t[2]*e,this},l.prototype.distanceToSquared=function(e,t,r){var n=this.elements[0]-e,i=this.elements[1]-t,a=this.elements[2]-r;return n*n+i*i+a*a},l.prototype.subtract=function(e){var t=this.elements;return e=e.elements,t[0]=t[0]-e[0],t[1]=t[1]-e[1],t[2]=t[2]-e[2],this};var u=function(e){var t=new Float32Array(4);e&&"object"===(void 0===e?"undefined":i(e))&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),this.elements=t};u.prototype.set=function(e){var t=this.elements;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this},u.prototype.add=function(e){var t=this.elements;return e=e.elements,t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=t[3]+e[3],this},u.prototype.normalize=function(){var e=this.elements[0],t=this.elements[1],r=this.elements[2],n=this.elements[3],i=e*e+t*t+r*r+n*n;return i>0&&(i=1/Math.sqrt(i),this.elements[0]=e*i,this.elements[1]=t*i,this.elements[2]=r*i,this.elements[3]=n*i),this},l.prototype.divideScalar=function(e){return this.scale(1/e)},l.prototype.applyMatrix4=function(e){var t=this.elements[0],r=this.elements[1],n=this.elements[2],i=e.elements;this.elements[0]=i[0]*t+i[4]*r+i[8]*n+i[12],this.elements[1]=i[1]*t+i[5]*r+i[9]*n+i[13],this.elements[2]=i[2]*t+i[6]*r+i[10]*n+i[14];var a=i[3]*t+i[7]*r+i[11]*n+i[15];return this.divideScalar(a)},u.prototype.lerp=function(e,t,r){var n=this.elements,i=e[0],a=e[1],s=e[2],o=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=s+r*(t[2]-s),n[3]=o+r*(t[3]-o),this},l.prototype.lerp=function(e,t,r){var n=this.elements,i=e[0],a=e[1],s=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=s+r*(t[2]-s),this},t.Matrix2=a,t.Matrix3=s,t.Matrix4=o,t.Vector3=l,t.Vector4=u,t.Frustum=n},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t){n(this,e),this.redraw=t,document.addEventListener("wheel",this),document.addEventListener("mousedown",this),document.addEventListener("mousemove",this),document.addEventListener("mouseup",this),document.addEventListener("keyup",this),document.addEventListener("keydown",this),this.position=[0,0,0]}return i(e,[{key:"handleEvent",value:function(e){switch(e.type){case"wheel":this.zoom(e);break;case"mousedown":this.onStart(e);break;case"mousemove":this.onMove(e);break;case"mouseup":this.onEnd(e);break;case"keyup":this.onKeyUp(e);break;case"keydown":this.onKeyDown(e)}}},{key:"onKeyDown",value:function(e){(e.shiftKey||e.ctrlKey)&&(this.isPan=!0)}},{key:"onKeyUp",value:function(e){this.isPan=!1}},{key:"onStart",value:function(e){this.x=e.clientX,this.y=e.clientY,this.isDrag=!0}},{key:"onMove",value:function(e){this.isDrag&&(this.isPan?this.redraw("pan",[e.clientX-this.x,e.clientY-this.y]):(this.redraw("rotate",[this.x,this.y],[e.clientX,e.clientY]),this.x=e.clientX,this.y=e.clientY))}},{key:"onEnd",value:function(e){this.isDrag=!1}},{key:"zoom",value:function(e){this.zoom.v||(this.zoom.v=0),this.zoom.v=Math.min(this.zoom.v+e.deltaY,1250),this.redraw("zoom",Math.pow(1.001,this.zoom.v))}}]),e}();t.Events=a},function(e,t,r){"use strict";function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=t.Bone=t.SkinnedMesh=t.Mesh=t.Object3D=t.Scene=void 0;var o=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(n)},l=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(0),h=function(){function e(t,r){s(this,e),this.uuid=Math.floor(Date.now()*Math.random()),this.name=t,this.children=[],this.matrix=new u.Matrix4,this.matrixWorld=new u.Matrix4,this.matrixAnimation=new u.Matrix4,this.parent=r}return l(e,[{key:"setPosition",value:function(e,t,r){var n,i;this.hasPosition=!0,this.matrix.makeRotationFromQuaternion(t),(n=this.matrix).scale.apply(n,a(r)),(i=this.matrix).setTranslate.apply(i,a(e)),this.matrixAnimation.set(this.matrix.elements)}},{key:"setMatrix",value:function(e){this.matrix.set(e),this.matrixAnimation.set(e)}},{key:"setMatrixWorld",value:function(e){this.matrixWorld.set(e)}}]),e}(),c=function(e){function t(e,r){s(this,t);var i=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return i.geometry={boundingSphere:{center:new u.Vector3}},i.material={},i.program=null,i.mode=4,i}return i(t,e),l(t,[{key:"setBlend",value:function(e){this.material.blend=e}},{key:"calculateBounding",value:function(){for(var e=this.geometry.attributes.a_position.value,t=0,r=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],i=0;i<e.length;i+=3){var a=e[i],s=e[i+1],o=e[i+2];r[0]=Math.min(r[0],a),r[1]=Math.min(r[1],s),r[2]=Math.min(r[2],o),n[0]=Math.max(n[0],a),n[1]=Math.max(n[1],s),n[2]=Math.max(n[2],o)}this.geometry.boundingSphere.center.add(new u.Vector3(r)).add(new u.Vector3(n)).scale(.5);for(var l=0;l<e.length;l+=3)t=Math.max(t,this.geometry.boundingSphere.center.distanceToSquared(e[l],e[l+1],e[l+2]));this.geometry.boundingSphere.radius=Math.sqrt(t)}},{key:"setIndicesBuffer",value:function(e){this.geometry.indicesBuffer=e}},{key:"setAttributes",value:function(e){this.geometry.attributes=e,this.calculateBounding()}},{key:"setTextures",value:function(e){this.material.texture=e}},{key:"setUniforms",value:function(e){this.material.uniforms=e}},{key:"setTechnique",value:function(e){this.material.technique=e}},{key:"setProgram",value:function(e){this.program=e}},{key:"setMode",value:function(e){this.mode=e}},{key:"getJointMatrix",value:function(){for(var e=this.material.uniforms.u_jointMat.value,t=new u.Matrix4(this.matrixWorld).invert(),r=[],n=0;n<e.length;n++){var i=new u.Matrix4(e[n]).multiply(t).multiply(this.bones[n].matrixWorld).multiply(this.boneInverses[n]).multiply(this.bindShapeMatrix);r.push(i)}return r}},{key:"getModelViewProjMatrix",value:function(e){var t=new u.Matrix4;return t.multiply(e.projection),t.multiply(e.matrixWorldInvert),t.multiply(this.matrixWorld),t}},{key:"getViewMatrix",value:function(e){var t=new u.Matrix4;return t.multiply(e.matrixWorldInvert),t}},{key:"getModelViewMatrix",value:function(e,t){var r=new u.Matrix4;return r.multiply(t.matrixWorldInvert),r.multiply(e||this.matrixWorld),r}},{key:"getProjectionMatrix",value:function(e){return e.projection}},{key:"getNormalMatrix",value:function(){var e=new u.Matrix3;return e.normalFromMat4(this.material.uniforms.u_modelViewMatrix.value),e}},{key:"isVisible",value:function(e){var t=new u.Vector3(this.geometry.boundingSphere.center.elements).applyMatrix4(this.matrixWorld),r=this.geometry.boundingSphere.radius*this.matrixWorld.getMaxScaleOnAxis(),n=void 0,i=!0,a=!0,s=!1,o=void 0;try{for(var l,h=e[Symbol.iterator]();!(a=(l=h.next()).done);a=!0){var c=l.value;if((n=c.elements[0]*t.elements[0]+c.elements[1]*t.elements[1]+c.elements[2]*t.elements[2]+c.elements[3])<-r){i=!1;break}}}catch(e){s=!0,o=e}finally{try{!a&&h.return&&h.return()}finally{if(s)throw o}}return this.distance=n+r,i}}]),t}(h),m=function(e){function t(e,r){return s(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return i(t,e),l(t,[{key:"setSkin",value:function(e){this.skin=e}}]),t}(c),f=function(e){function t(e,r){return s(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return i(t,e),l(t,[{key:"setJointName",value:function(e){this.jointName=e}}]),t}(h),v=function(e){function t(e,r){s(this,t);var i=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return i.matrixWorldInvert=new u.Matrix4,i.projection=new u.Matrix4,i}return i(t,e),l(t,[{key:"setProjection",value:function(e){this.projection.set(e)}},{key:"setMatrixWorld",value:function(e){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setMatrixWorld",this).call(this,e),this.matrixWorldInvert.setInverseOf(this.matrixWorld)}},{key:"setMatrixWorldInvert",value:function(e){var t;(t=this.matrixWorldInvert).lookAt.apply(t,a(e))}},{key:"getViewProjMatrix",value:function(){var e=new u.Matrix4;return e.multiply(this.projection),e.multiply(this.matrixWorldInvert),e}}]),t}(h),d=function e(){s(this,e),this.children=[],this.program=[],this.matrixWorld=new u.Matrix4,this.bin=[]};t.Scene=d,t.Object3D=h,t.Mesh=c,t.SkinnedMesh=m,t.Bone=f,t.Camera=v},function(e,t,r){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.RedCube=void 0;var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(2),o=r(0),l=r(1),u=void 0,h=function(){function e(t,r){i(this,e),this.reflow=!0,this.scene=new s.Scene,this.color=[.6,.6,.6,1],this.url=t,this.host=t.substr(0,t.lastIndexOf("/")+1),this.canvas=r,this.cameras=[],this.aspect=this.canvas.width/this.canvas.height,this._camera=new s.Camera,this._camera.prop={type:"perspective",perspective:{yfov:.5235987755982988,znear:1,zfar:1e3,aspectRatio:this.aspect}},this.zoom=1,this._camera.setProjection(this.buildCamera(this._camera.prop).elements),this._camera.setMatrixWorldInvert([0,0,5,0,0,0,0,1,0]),this.unblendEnable={},this.blendEnable={},this.blendTechnique={},this.tracks=[],this.skins={},this.json=null,this.glEnum={},this.textures={},this.events=new l.Events(this.redraw.bind(this)),this.cameraPosition=new o.Vector3([0,0,.05])}return a(e,[{key:"redraw",value:function(e,t,r){if("zoom"===e&&(this.zoom=t,this._camera.setProjection(this.buildCamera(this._camera.prop).elements)),"rotate"===e){var i=new o.Vector3(this.sceneToArcBall(this.canvasToWorld.apply(this,n(t)))),a=new o.Vector3(this.sceneToArcBall(this.canvasToWorld.apply(this,n(r)))),s=2*o.Vector3.angle(i,a);if(s<1e-6||isNaN(s))return;var l=o.Vector3.cross(i,a).normalize(),u=Math.sin(s/2),h=new o.Vector4([l.elements[0]*u,l.elements[1]*u,l.elements[2]*u,Math.cos(s/2)]),c=new o.Vector3([this._camera.matrixWorldInvert.elements[12],this._camera.matrixWorldInvert.elements[13],this._camera.matrixWorldInvert.elements[14]]),m=new o.Matrix4;m.makeRotationFromQuaternion(h.elements),this._camera.matrix.multiply(m),this._camera.setMatrixWorld(this._camera.matrix.elements),this._camera.matrixWorldInvert.setTranslate(c.elements[0],c.elements[1],c.elements[2])}if("pan"===e){var f=this._camera.matrixWorldInvert.elements[14];this._camera.matrix.elements[12]=-.005*t[0],this._camera.matrix.elements[13]=.005*t[1],this._camera.setMatrixWorld(this._camera.matrix.elements),this._camera.matrixWorldInvert.elements[14]=f}this.reflow=!0}},{key:"sceneToArcBall",value:function(e){var t=e.elements[0]*e.elements[0]+e.elements[1]*e.elements[1],r=.0016-t;return r>0?[e.elements[0],e.elements[1],Math.sqrt(r)]:(t=Math.sqrt(t),[.04*e.elements[0]/t,.04*e.elements[1]/t,0])}},{key:"canvasToWorld",value:function(e,t){var r=new o.Matrix4;r.setTranslate.apply(r,n(this.cameraPosition.elements));var i=new o.Matrix4(this._camera.projection);i.multiply(r);var a=i.multiplyVector4(new o.Vector4([0,0,0,1]));return a.elements[0]=(2*e/this.canvas.width-1)*a.elements[3],a.elements[1]=(-2*t/this.canvas.height+1)*a.elements[3],i.invert().multiplyVector4(a)}},{key:"init",value:function(){return this.getJson().then(this.glInit.bind(this)).then(this.getBuffer.bind(this)).then(this.buildMesh.bind(this)).then(this.initTextures.bind(this)).then(this.buildAnimation.bind(this)).then(this.buildSkin.bind(this)).then(this.draw.bind(this)).catch(console.error)}},{key:"setColor",value:function(e){this.color=e}},{key:"walk",value:function(e,t){function r(e){t(e),e.children&&e.children.forEach(r)}r(e)}},{key:"isMatrix",value:function(e){return"FLOAT_MAT4"===this.glEnum[e]||"FLOAT_MAT3"===this.glEnum[e]||"FLOAT_MAT2"===this.glEnum[e]}},{key:"getMatrixType",value:function(e){return"FLOAT_MAT4"===this.glEnum[e]?o.Matrix4:"FLOAT_MAT3"===this.glEnum[e]?o.Matrix3:"FLOAT_MAT2"===this.glEnum[e]?o.Matrix2:void 0}},{key:"getBuffer",value:function(){var e=this;return fetch(""+this.host+this.scene.bin[0]).then(function(e){return e.arrayBuffer()}).then(function(t){return e.arrayBuffer=t,!0})}},{key:"buildPrim",value:function(e,t,r,n){var i=this,a=this.json.accessors[n.indices],o={};for(var l in n.attributes)o[l.toLowerCase().replace(/_(\d)/,"$1")]=this.json.accessors[n.attributes[l]];var h=this.json.materials[n.material].values,c=this.json.materials[n.material].technique,m=this.json.techniques[c],f={};for(var v in m.attributes)f[v]={type:m.parameters[m.attributes[v]].type,semantic:m.parameters[m.attributes[v]].semantic};var d={};for(var p in m.uniforms){var y=m.parameters[m.uniforms[p]],b=y.node,x=y.value;b&&(b=this.json.nodes[b].matrix),d[p]={type:y.type,value:x,semantic:y.semantic,node:b,count:y.count}}for(var w in h)void 0!==h[w]&&(d["u_"+w].value=h[w]);var g=[];for(var M in d){var k=d[M];if(k.type===u.SAMPLER_2D){var E=Object.assign({},this.json.textures[k.value]);Object.assign(E,this.json.samplers[E.sampler]),Object.assign(E,this.json.images[E.source]),g.push(E)}if(void 0===k.value||Array.isArray(k.value)||(k.value=[k.value]),void 0===k.node||Array.isArray(k.node)||(k.node=[k.node]),k.value&&this.isMatrix(k.type)){var A=this.getMatrixType(k.type);k.value=(new A).set(k.value)}if(k.node&&this.isMatrix(k.type)){var T=this.getMatrixType(k.type);k.node=(new T).set(k.node)}k.count&&!k.value&&function(){var e=i.getMatrixType(k.type);k.value=new Array(k.count).fill(1).map(function(){return new e})}()}var _=void 0;if(a){_={};var O=this.json.bufferViews[a.bufferView];_.value=this.buildArray(a.componentType,O.byteOffset+a.byteOffset,this.getDataType(a.type)*a.count)}for(var j in o)if(f["a_"+j]){var S=o[j],P=this.json.bufferViews[S.bufferView];f["a_"+j].value=this.buildArray(S.componentType,P.byteOffset+S.byteOffset,this.getDataType(S.type)*S.count)}var V=void 0;t.skin?(V=new s.SkinnedMesh(r,e),V.setSkin(t.skin)):V=new s.Mesh(r,e);var R=m.states.enable.some(function(e){return"BLEND"===i.glEnum[e]});if(R){V.setBlend(R),Object.assign(this.blendTechnique,m.states.functions);var F=!0,I=!1,B=void 0;try{for(var W,L=m.states.enable[Symbol.iterator]();!(F=(W=L.next()).done);F=!0){var N=W.value;this.blendEnable[N]=!0}}catch(e){I=!0,B=e}finally{try{!F&&L.return&&L.return()}finally{if(I)throw B}}}else{var C=!0,D=!1,z=void 0;try{for(var U,q=m.states.enable[Symbol.iterator]();!(C=(U=q.next()).done);C=!0){var Y=U.value;this.unblendEnable[Y]=!0}}catch(e){D=!0,z=e}finally{try{!C&&q.return&&q.return()}finally{if(D)throw z}}}return V.setTechnique(m.states),V.setProgram(this.scene.program.find(function(e){return e.name===m.program}).program),V.setMode(n.mode),V.setUniforms(d),V.setAttributes(f),V.setIndicesBuffer(_),V.setTextures(g),V}},{key:"buildCamera",value:function(e){var t=void 0;if("perspective"==e.type&&e.perspective){var r=e.perspective.yfov,n=e.perspective.aspectRatio||this.aspect,i=r*this.aspect;this.aspect!==n&&console.warn("this.canvas size and this.canvas size from scene dont equal"),t=(new o.Matrix4).setPerspective(i*this.zoom*(180/Math.PI),this.aspect,e.perspective.znear||1,e.perspective.zfar||2e6)}else"orthographic"==e.type&&e.orthographic&&(t=(new o.Matrix4).setOrtho(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar));return t}},{key:"walkByMesh",value:function(e,t){var r=this,i=this.json.nodes[t],a=void 0;if(i.camera){var o=this.buildCamera(this.json.cameras[i.camera]);a=new s.Camera(t,e),a.prop=this.json.cameras[i.camera],a.setProjection(o.elements),a.setMatrix(i.matrix),a.setMatrixWorld(i.matrix),this.cameras.push(a)}else i.jointName?(a=new s.Bone(t,e),a.setJointName(i.jointName)):a=new s.Object3D(t,e),i.translation&&i.rotation&&i.scale?a.setPosition(i.translation,i.rotation,i.scale):i.matrix&&a.setMatrix(i.matrix);e.children.push(a),e=a,i.children&&i.children.length?i.children.forEach(this.walkByMesh.bind(this,e)):i.meshes&&i.meshes.length&&i.meshes.forEach(function(t){var a;(a=e.children).push.apply(a,n(r.json.meshes[t].primitives.map(r.buildPrim.bind(r,e,i,t))))})}},{key:"buildMesh",value:function(){var e=this;return this.json.scenes.defaultScene.nodes.forEach(function(t){if(e.json.nodes[t].children.length&&e.walkByMesh(e.scene,t),e.json.nodes[t].meshes&&e.json.nodes[t].meshes.length&&e.json.nodes[t].meshes.forEach(function(r){var i;(i=e.scene.children).push.apply(i,n(e.json.meshes[r].primitives.map(e.buildPrim.bind(e,e.scene,e.json.nodes[t],r))))}),e.json.nodes[t].camera){var r=e.buildCamera(e.json.cameras[e.json.nodes[t].camera]);e._camera=new s.Camera,e._camera.prop=e.json.cameras[e.json.nodes[t].camera],e._camera.setProjection(r.elements),e._camera.setMatrix(e.json.nodes[t].matrix),e._camera.setMatrixWorld(e.json.nodes[t].matrix)}}),!0}},{key:"buildAnimation",value:function(){var e=this;for(var t in this.json.animations){var r=this.json.animations[t];for(var n in r.channels){var i=r.channels[n],a=r.samplers[i.sampler];a&&function(){for(var t=i.target,n=t.id,s=void 0!==r.parameters?r.parameters[a.input]:a.input,o=void 0!==r.parameters?r.parameters[a.output]:a.output,l=e.json.accessors[s],u=e.json.accessors[o],h=e.json.bufferViews[l.bufferView],c=e.json.bufferViews[u.bufferView],m=e.buildArray(l.componentType,h.byteOffset+l.byteOffset,e.getDataType(l.type)*l.count),f=e.buildArray(u.componentType,c.byteOffset+u.byteOffset,e.getDataType(u.type)*u.count),v=e.getAnimationComponent(t.path),d=[],p=0;p<m.length;p++){var y=void 0,b=void 0;b=m[p],y=f.slice(p*v,(p+1)*v),d.push({time:b,value:y})}var x=e.json.nodes[n],w=void 0,g=void 0;!function e(t){g||(t.name+"Node"!==n&&t.name!==n||(w=t,g=!0),t.children&&t.children.forEach(e))}(e.scene),x&&e.tracks.push({mesh:w,type:t.path,name:x.name+"."+t.path,keys:d,interpolation:a.interpolation})}()}}return!0}},{key:"buildSkin",value:function(){for(var e in this.json.skins){var t=this.json.skins[e],r=new o.Matrix4;void 0!==t.bindShapeMatrix&&r.set(t.bindShapeMatrix);var n=this.json.accessors[t.inverseBindMatrices],i=this.json.bufferViews[n.bufferView],a=this.buildArray(n.componentType,i.byteOffset+n.byteOffset,this.getDataType(n.type)*n.count);this.skins[e]={bindShapeMatrix:r,jointNames:t.jointNames,inverseBindMatrices:a};var s=0,l=this.skins[e];l.bones=[],l.boneInverses=[];var u=!0,h=!1,c=void 0;try{for(var m,f=l.jointNames[Symbol.iterator]();!(u=(m=f.next()).done);u=!0){var v=m.value;this.walk(this.scene,this.buildBones.bind(this,v,l));var d=l.inverseBindMatrices,p=(new o.Matrix4).set(d.slice(16*s,16*(s+1)));l.boneInverses.push(p),s++}}catch(e){h=!0,c=e}finally{try{!u&&f.return&&f.return()}finally{if(h)throw c}}}return!0}},{key:"buildBones",value:function(e,t,r){r.jointName===e&&t.bones.push(r)}},{key:"buildArray",value:function(e,t,r){var n=void 0;switch(this.glEnum[e]){case"BYTE":n=new Int8Array(this.arrayBuffer,t,r);break;case"UNSIGNED_BYTE":n=new Uint8Array(this.arrayBuffer,t,r);break;case"SHORT":n=new Int16Array(this.arrayBuffer,t,r);break;case"UNSIGNED_SHORT":n=new Uint16Array(this.arrayBuffer,t,r);break;case"FLOAT":n=new Float32Array(this.arrayBuffer,t,r)}return n}},{key:"getDataType",value:function(e){var t=void 0;switch(e){case"MAT2":t=4;break;case"MAT3":t=9;break;case"MAT4":t=16;break;case"VEC4":t=4;break;case"VEC3":t=3;break;case"VEC2":t=2;break;case"SCALAR":t=1}return t}},{key:"getComponentType",value:function(e){var t=void 0;switch(this.glEnum[e]){case"FLOAT_VEC4":t=4;break;case"FLOAT_VEC3":t=3;break;case"FLOAT_VEC2":t=2}return t}},{key:"getJson",value:function(){var e=this;return fetch(this.url).then(function(e){return e.json()}).then(function(t){for(var r in t.programs)t.programs[r].shaders=[],t.programs[r].name=r,e.scene.program.push(t.programs[r]);for(var n in t.buffers)e.scene.bin.push(t.buffers[n].uri);return e.json=t,!0})}},{key:"buildBuffer",value:function(e){if(e)if(e.buffer)u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,e.buffer);else{var t=u.createBuffer();u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,t),u.bufferData(u.ELEMENT_ARRAY_BUFFER,e.value,u.STATIC_DRAW),e.buffer=t}for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];n.forEach(function(e){if(!e.buffer){var t=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,t),u.bufferData(u.ARRAY_BUFFER,e.value,u.STATIC_DRAW),e.buffer=t}})}},{key:"glInit",value:function(){var e=this;u=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");for(var t in u){var r=u[t];"number"==typeof r&&(this.glEnum[r]=t)}var n=[],i=!0,a=!1,s=void 0;try{for(var o,l=this.scene.program[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var h=o.value;n.push(fetch(""+this.host+h.fragmentShader+".glsl").then(function(e){return e.text()})),n.push(fetch(""+this.host+h.vertexShader+".glsl").then(function(e){return e.text()}))}}catch(e){a=!0,s=e}finally{try{!i&&l.return&&l.return()}finally{if(a)throw s}}return Promise.all(n).then(function(t){var r=void 0,n=0,i=!0,a=!1,s=void 0;try{for(var o,l=t[Symbol.iterator]();!(i=(o=l.next()).done);i=!0){var h=o.value;r||(r=u.createProgram());var c=void 0;c=/gl_Position/.test(h)?u.VERTEX_SHADER:u.FRAGMENT_SHADER;var m=u.createShader(c);u.shaderSource(m,h),u.compileShader(m),u.attachShader(r,m);2===e.scene.program[n].shaders.push(m)&&(e.scene.program[n].program=r,u.linkProgram(r),r=null,n++)}}catch(e){a=!0,s=e}finally{try{!i&&l.return&&l.return()}finally{if(a)throw s}}return!0})}},{key:"getMethod",value:function(e){var t=void 0;switch(this.glEnum[e]){case"FLOAT_VEC2":t="uniform2f";break;case"FLOAT_VEC4":t="uniform4f";break;case"FLOAT":t="uniform1f";break;case"FLOAT_VEC3":t="uniform3f";break;case"FLOAT_MAT4":t="uniformMatrix4fv";break;case"FLOAT_MAT3":t="uniformMatrix3fv";break;case"FLOAT_MAT2":t="uniformMatrix2fv";break;case"SAMPLER_2D":t="uniform1i"}return t}},{key:"getAnimationComponent",value:function(e){return"rotation"===e?4:3}},{key:"getAnimationMethod",value:function(e){return"rotation"===e?"makeRotationFromQuaternion":"scale"===e?"scale":"translation"===e?"setTranslate":void 0}},{key:"range",value:function(e,t,r){return(r-e)/(t-e)}},{key:"interpolation",value:function(e,t){if(0===t.length)return[-1,-1,0];for(var r=-1,n=t.length-1;n>=0;n--)if(e>=t[n].time){r=n;break}if(-1===r||r===t.length-1)return r<0&&(r=0),[r,r,0];var i=t[r],a=t[r+1];return e=Math.max(i.time,Math.min(e,a.time)),[r,r+1,this.range(i.time,a.time,e)]}},{key:"animate",value:function(e){var t=!0,r=!1,i=void 0;try{for(var a,s=this.tracks[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var l=a.value,u=this.interpolation(e,l.keys);if(-1!==u[0]&&-1!==u[1]&&!l.stoped){u[0]===l.keys.length-1&&(l.stoped=!0);var h=l.keys[u[0]],c=l.keys[u[1]],m=u[2],f=this.getAnimationComponent(l.type),v=void 0,d=void 0,p=3===f?o.Vector3:o.Vector4;if(v=new p(h.value),d=new p(c.value),"rotation"===l.type){var y=new o.Vector4;y.lerp(v.elements,d.elements,m),l.mesh.matrixAnimation[this.getAnimationMethod(l.type)](y.elements)}else{var b,x=new o.Vector3;x.lerp(v.elements,d.elements,m),(b=l.mesh.matrixAnimation)[this.getAnimationMethod(l.type)].apply(b,n(x.elements))}this.reflow=!0}}}catch(e){r=!0,i=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw i}}}},{key:"setMesh",value:function(e,t,r){if(r.parent&&r.parent.matrixWorld){var n=new o.Matrix4;n.multiply(r.parent.matrixWorld),n.multiply(r.matrixAnimation),r.setMatrixWorld(n.elements)}r instanceof s.SkinnedMesh&&(r.bones=this.skins[r.skin].bones,r.boneInverses=this.skins[r.skin].boneInverses,r.bindShapeMatrix=this.skins[r.skin].bindShapeMatrix),(r instanceof s.SkinnedMesh||r instanceof s.Mesh)&&(r.material.blend?e.push(r):t.push(r))}},{key:"draw",value:function(){var e;(e=u).clearColor.apply(e,n(this.color)),this.render()}},{key:"render",value:function(e){var t=e/1e3;if(this.animate(t),this.reflow){u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENSIL_BUFFER_BIT);var r=[],i=[];this.walk(this.scene,this.setMesh.bind(this,r,i));var a=(0,o.Frustum)(this._camera.getViewProjMatrix());if(i.length){for(var s in this.unblendEnable)u.enable(s);var l=!0,h=!1,c=void 0;try{for(var m,f=i[Symbol.iterator]();!(l=(m=f.next()).done);l=!0){var v=m.value;v.isVisible(a)&&(this.buildBuffer.apply(this,[v.geometry.indicesBuffer].concat(n(Object.values(v.geometry.attributes)))),this._draw(v))}}catch(e){h=!0,c=e}finally{try{!l&&f.return&&f.return()}finally{if(h)throw c}}for(var d in this.unblendEnable)u.disable(d)}if(r.length){var p=[],y=!0,b=!1,x=void 0;try{for(var w,g=r[Symbol.iterator]();!(y=(w=g.next()).done);y=!0){var M=w.value;M.isVisible(a)&&p.push(M)}}catch(e){b=!0,x=e}finally{try{!y&&g.return&&g.return()}finally{if(b)throw x}}if(p.length){p.sort(function(e,t){return e.distance-t.distance});for(var k in this.blendEnable)u.enable(k);for(var E in this.blendTechnique){var A;(A=u)[E].apply(A,n(this.blendTechnique[E]))}var T=!0,_=!1,O=void 0;try{for(var j,S=p[Symbol.iterator]();!(T=(j=S.next()).done);T=!0){var P=j.value;this.buildBuffer.apply(this,[P.geometry.indicesBuffer].concat(n(Object.values(P.geometry.attributes)))),this._draw(P)}}catch(e){_=!0,O=e}finally{try{!T&&S.return&&S.return()}finally{if(_)throw O}}for(var V in this.blendEnable)u.disable(V);for(var R in this.blendTechnique)"depthMask"===R&&u[R](!0),"blendFuncSeparate"===R&&u[R](u.ONE,u.ZERO,u.ONE,u.ZERO),"blendEquationSeparate"===R&&u[R](u.FUNC_ADD,u.FUNC_ADD)}}}this.reflow=!1,requestAnimationFrame(this.render.bind(this))}},{key:"_draw",value:function(e){u.useProgram(e.program);var t=this._camera;for(var r in e.geometry.attributes){var i=e.geometry.attributes[r];u.bindBuffer(u.ARRAY_BUFFER,i.buffer);var a=void 0;if(void 0!==i[r])a=i[r];else{if(0!==(a=u.getAttribLocation(e.program,r))&&!a){console.warn("dont get "+r+" from shader"),delete e.geometry.attributes[r];continue}i[r]=a,u.enableVertexAttribArray(a)}u.vertexAttribPointer(a,this.getComponentType(i.type),u.FLOAT,!1,0,0)}var s=0;for(var l in e.material.uniforms){var h=e.material.uniforms[l],c=void 0;switch(h.type===u.SAMPLER_2D&&(u.activeTexture(u["TEXTURE"+s]),u.bindTexture(e.material.texture[s].target,this.textures[e.material.texture[s].name].data),h.value=[s],s++),h.semantic){case"MODELVIEWPROJECTION":h.value=e.getModelViewProjMatrix(t);break;case"MODELVIEWPROJECTIONINVERSE":h.value=e.getModelViewProjMatrix(t).invert();break;case"VIEW":h.value=e.getViewMatrix(t);break;case"VIEWINVERSE":h.value=e.getViewMatrix(t).invert();break;case"MODEL":h.value=e.matrixWorld;break;case"MODELINVERSETRANSPOSE":h.value=(new o.Matrix3).normalFromMat4(e.matrixWorld);break;case"MODELINVERSE":h.value=new o.Matrix4(e.matrixWorld).invert();break;case"MODELVIEW":h.value=e.getModelViewMatrix(h.node,t);break;case"MODELVIEWINVERSE":h.value=e.getModelViewMatrix(h.node,t).invert();break;case"PROJECTION":h.value=e.getProjectionMatrix(t);break;case"PROJECTIONINVERSE":h.value=new o.Matrix4(e.getProjectionMatrix(t)).invert();break;case"MODELVIEWINVERSETRANSPOSE":h.value=e.getNormalMatrix();break;case"VIEWPORT":h.value=new Float32Array([0,0,this.canvas.width,this.canvas.height]);break;case"JOINTMATRIX":c=e.getJointMatrix()}var m=void 0;if(void 0!==h[l])m=h[l];else{if(0!==(m=u.getUniformLocation(e.program,l))&&!m){console.warn("dont get "+l+" from shader"),delete e.material.uniforms[l];continue}h[l]=m}var f=void 0;if(void 0!==h.value?f=h.value:void 0!==h.node&&(f=h.node),f.elements)u[this.getMethod(h.type)](m,!1,f.elements);else if(c){var v=new Float32Array(16*c.length),d=0,p=!0,y=!1,b=void 0;try{for(var x,w=c[Symbol.iterator]();!(p=(x=w.next()).done);p=!0){var g=x.value;v.set(g.elements,16*d),d++}}catch(e){y=!0,b=e}finally{try{!p&&w.return&&w.return()}finally{if(y)throw b}}u[this.getMethod(h.type)](m,!1,v)}else{var M;(M=u)[this.getMethod(h.type)].apply(M,[m].concat(n(f)))}}e.geometry.indicesBuffer?u.drawElements(e.mode,e.geometry.indicesBuffer.value.length,u.UNSIGNED_SHORT,0):u.drawArrays(e.mode,0,e.geometry.attributes.a_position.value.length/3)}},{key:"walkTexture",value:function(e){var t=this;e.material&&e.material.texture&&e.material.texture.forEach(function(e){t.textures[e.name]||(t.textures[e.name]=e)})}},{key:"initTextures",value:function(){var e=this;this.walk(this.scene,this.walkTexture.bind(this));var t=Object.values(this.textures).map(function(t){return new Promise(function(r,n){var i=new Image;i.onload=function(){e.handleTextureLoaded(t,i),r()},i.onerror=function(e){n(e)},i.crossOrigin="anonymous",i.src=""+e.host+t.uri})});return Promise.all(t)}},{key:"handleTextureLoaded",value:function(e,t){e.data=u.createTexture(),u.bindTexture(e.target,e.data),u.texImage2D(e.target,0,e.format,e.internalFormat,e.type,t),u.texParameteri(e.target,u.TEXTURE_WRAP_S,e.wrapS),u.texParameteri(e.target,u.TEXTURE_WRAP_T,e.wrapT),u.texParameteri(e.target,u.TEXTURE_MAG_FILTER,e.magFilter),u.texParameteri(e.target,u.TEXTURE_MIN_FILTER,e.minFilter),u.generateMipmap(e.target)}}]),e}();t.RedCube=h}])});